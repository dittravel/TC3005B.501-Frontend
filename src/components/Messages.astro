---
/**
 * This component fetches and displays system notifications (alerts) 
 * for the user based on their role and department.
 */

import { apiRequest } from "@/utils/apiClient";
import { getCookie } from "@data/cookies";

// Status dictionary mapped by user role
const statusByRole = {
  'Solicitante': 1,
  'Agencia de viajes': 2,
  'Cuentas por pagar': 3,
  'N1': 4,
  'N2': 5,
  'Administrador': 6,
};

type UserRole = keyof typeof statusByRole;
const userRole = getCookie("role", Astro.cookies) as UserRole;
const status = statusByRole[userRole];
const alerts = await (async () => {
  try {
    return await apiRequest(`/authorizer/get-alerts/${getCookie("department_id", Astro.cookies)}/${status}/10`, { cookies: Astro.cookies });
  } catch (error) {
    return [];
  }
})()
---

<div class="h-full w-full flex flex-col bg-card p-4 border-l border-border">
  <h2 class="text-xl font-bold text-text-primary mb-6 break-words">Notificaciones</h2>
  <ul class="space-y-4 pb-8 overflow-hidden">
    {alerts.length === 0 && (
      <li>
        <div class="flex flex-col p-4 h-48 border border-border rounded-xl shadow-md">
          <span class="text-lg text-neutral-700 font-semibold">No hay notificaciones disponibles</span>
          <span class="text-sm text-neutral-500 mt-1">Las notificaciones del sistema aparecerán aquí cuando estén disponibles.</span>
        </div>
      </li>
    )}
    {alerts.map((alert:any) => (
      <li class="relative bg-card border border-border rounded-xl p-4 shadow-sm overflow-hidden">
        <div class="mb-4">
          <p class="text-xs text-neutral-500 mb-2">
            {
              new Date(alert.alert_date.replace(/:([0-9]{3})Z$/, '.$1Z'))
              .toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })
            } - {alert.alert_time}
          </p>
          <p class="text-xs text-neutral-500 mb-2">Usuario: <span class="font-semibold">{alert.user_name}</span></p>
          <p class="text-xs text-neutral-500 mb-2">ID de Solicitud: <span class="font-semibold">{alert.request_id}</span></p>
        </div>
        <div>
          <p class="text-sm text-text-primary">{alert.message_text}</p>
        </div>
      </li>
    ))}
  </ul>
</div>
