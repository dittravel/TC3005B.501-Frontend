---
/**
 * This script is used to create a page that shows the reimbursement panel for the user.
 */

import Button from '@components/Button';
import TextHeader from '@components/TextHeader.astro';
import MainLayout from "@layouts/MainLayout.astro";

import type { UserRole } from "@type/roles";
import { getCookie } from "@data/cookies";
import { roleLabels } from "@config/role-labels";

const role: UserRole = getCookie("role", Astro.cookies) as UserRole;
const userName = getCookie("username", Astro.cookies) || "";
const buttonLabel = roleLabels[role];

// Dummy data for demonstration
const currentBalance = 1250.75; // Positive means company owes applicant
const reimbursementHistory = [
  { id: 1, date: '2023-10-15', amount: 850.50, status: 'paid', requestId: 'TRV-2023-045' },
  { id: 2, date: '2023-09-02', amount: 400.25, status: 'paid', requestId: 'TRV-2023-032' },
  { id: 3, date: '2023-11-20', amount: 1200.00, status: 'approved', requestId: 'TRV-2023-058' },
  { id: 4, date: '2023-12-05', amount: 750.00, status: 'pending', requestId: 'TRV-2023-067' }
];

const verifiedReceipts = [
  { id: 1, date: '2023-11-15', amount: 350.00, description: 'Hotel accommodation' },
  { id: 2, date: '2023-11-16', amount: 125.75, description: 'Meal expenses' },
  { id: 3, date: '2023-11-17', amount: 85.00, description: 'Transportation' }
];
---

<MainLayout title="Panel de Reembolsos" data={{userName, buttonLabel, role}}>
  <div>
    <TextHeader
      title="Panel de reembolsos"
      subtitle="Gestione sus reembolsos y solicitudes de devolución"
    />
    <main class="space-y-8">
      <!-- Balance Section -->
      <div class="card">
        <div class="border-b border-border pb-4 mb-6">
          <h3 class="text-lg font-bold text-text-primary">1. Balance Actual</h3>
        </div>
        
        <div class="bg-success/10 rounded-lg p-6" class:list={[
          currentBalance >= 0 ? '' : 'bg-warning/10',
        ]}>
          <div class="flex justify-between items-center">
            <div>
              <h4 class="text-lg font-medium text-text-primary">Saldo Actual</h4>
              <p class="text-sm text-text-secondary">
                {currentBalance >= 0 ? 'La empresa le debe' : 'Usted le debe a la empresa'}
              </p>
            </div>
            <span class:list={[
              'text-2xl font-bold',
              currentBalance >= 0 ? 'text-success-500' : 'text-warning-500'
            ]}>
              {currentBalance >= 0 ? '+' : ''}{currentBalance.toFixed(2)} USD
            </span>
          </div>
        </div>
      </div>

      <!-- Bank Information Section -->
      <div class="card">
        <div class="border-b border-border pb-4 mb-6">
          <h3 class="text-lg font-bold text-text-primary">2. Información Bancaria</h3>
          <p class="text-sm text-text-secondary mt-1">
            Por favor proporcione sus datos bancarios para recibir los reembolsos
          </p>
        </div>
        
        <form id="bankForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <div>
          <label class="block text-sm font-medium mb-1 text-text-secondary">Nombre del Banco</label>
          <input type="text" name="bankName" class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary placeholder:text-text-secondary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary" required />
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1 text-text-secondary">Nombre del Titular</label>
          <input type="text" name="accountHolder" class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary placeholder:text-text-secondary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary" required />
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1 text-text-secondary">Número de Cuenta</label>
          <input type="text" name="accountNumber" class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary placeholder:text-text-secondary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary" required />
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1 text-text-secondary">Tipo de Cuenta</label>
          <input type="text" name="accountType" class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary placeholder:text-text-secondary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary" required />
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1 text-text-secondary">Código SWIFT/BIC</label>
          <input type="text" name="swiftCode" class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary placeholder:text-text-secondary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary" required />
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1 text-text-secondary">Código IBAN</label>
          <input type="text" name="iban" class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary placeholder:text-text-secondary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary" required />
        </div>
        
        <div class="md:col-span-2 flex justify-end pt-4">
          <Button 
            variant="filled" 
            color="secondary"
          >
            Guardar Información Bancaria
          </Button>
        </div>
      </form>
      </div>

      <!-- Reimbursement Request Section -->
      <div class="card">
        <div class="border-b border-border pb-4 mb-6">
          <h3 class="text-lg font-bold text-text-primary">3. Solicitud de Reembolso</h3>
          <p class="text-sm text-text-secondary mt-1">
            {currentBalance > 0 ? 'Puede solicitar un reembolso hasta por el monto de su saldo disponible' : 'Actualmente no tiene saldo disponible para reembolso'}
          </p>
        </div>
        
        {currentBalance > 0 && (
        <form id="reimbursementForm" class="space-y-6 mb-8">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2 text-text-secondary">
                Monto a Solicitar (USD)
              </label>
              <input
                type="number"
                name="amount"
                min="0.01"
                max={currentBalance.toFixed(2)}
                step="0.01"
                required
                class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary placeholder:text-text-secondary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary"
              />
              <p class="text-xs text-text-secondary mt-1">
                Máximo disponible: {currentBalance.toFixed(2)} USD
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2 text-text-secondary">
                Comprobantes Verificados
              </label>
              <select
                name="receipts"
                multiple
                class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary h-10.5"
                required
              >
                {verifiedReceipts.map(receipt => (
                  <option value={receipt.id}>
                    {receipt.date} - {receipt.description} - ${receipt.amount.toFixed(2)}
                  </option>
                ))}
              </select>
              <p class="text-xs text-text-secondary mt-1">
                Mantenga presionado Ctrl para seleccionar múltiples comprobantes
              </p>
            </div>
          </div>
          
          <div>
            <label for="notes" class="block text-sm font-medium mb-2 text-text-secondary">
              Notas Adicionales
            </label>
            <textarea
              id="notes"
              name="notes"
              rows={3}
              class="w-full border border-border rounded-md px-3 py-2 bg-card text-text-primary placeholder:text-text-secondary focus:outline-none focus:border-secondary focus:ring-1 focus:ring-secondary"
            ></textarea>
          </div>
          
          <div class="flex justify-end pt-4">
            <Button 
              variant="filled" 
              color="secondary"
            >
              Solicitar Reembolso
            </Button>
          </div>
        </form>
        )}
      </div>

      <!-- Reimbursement History Section -->
      <div class="card">
        <div class="border-b border-border pb-4 mb-6">
          <h3 class="text-lg font-bold text-text-primary">4. Historial de Reembolsos</h3>
        </div>
        
        <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-border">
          <thead class="bg-secondary">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                Fecha
              </th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                Monto
              </th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                Estado
              </th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                Solicitud Relacionada
              </th>
            </tr>
          </thead>
          <tbody class="bg-card divide-y divide-border">
            {reimbursementHistory.map((item) => (
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-text-primary">
                  {item.date}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-text-primary">
                  ${item.amount.toFixed(2)}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">
                  <span class:list={[
                    'px-2 inline-flex text-xs leading-5 font-semibold rounded-full',
                    item.status === 'paid' ? 'bg-success/20 text-success-500' : '',
                    item.status === 'approved' ? 'bg-primary/20 text-text-primary' : '',
                    item.status === 'pending' ? 'bg-warning/20 text-warning-500' : ''
                  ]}>
                    {item.status === 'paid' ? 'Pagado' : ''}
                    {item.status === 'approved' ? 'Aprobado' : ''}
                    {item.status === 'pending' ? 'Pendiente' : ''}
                  </span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-secondary-500 underline">
                  <a href={`/requests/${item.requestId}`}>{item.requestId}</a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </main>
  </div>
</MainLayout>

<script is:inline>
  // Bank form submission handler
  document.getElementById('bankForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate required fields
    const requiredFields = this.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        field.classList.add('border-warning-500');
        isValid = false;
      } else {
        field.classList.remove('border-warning-500');
      }
    });

    if (!isValid) {
      alert('Por favor complete todos los campos requeridos');
      return;
    }

    // Collect form data
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
  
    
    // Show success message
    alert('Información bancaria guardada correctamente (demo frontend)');
  });

  // Reimbursement form submission handler
  document.getElementById('reimbursementForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate amount
    const amountInput = this.querySelector('[name="amount"]');
    const amount = parseFloat(amountInput.value);
    const maxAmount = parseFloat(amountInput.max);
    
    if (isNaN(amount) || amount <= 0) {
      alert('Por favor ingrese un monto válido');
      amountInput.classList.add('border-warning-500');
      return;
    }
    
    if (amount > maxAmount) {
      alert('El monto solicitado no puede exceder su saldo disponible');
      amountInput.classList.add('border-warning-500');
      return;
    }
    
    amountInput.classList.remove('border-warning-500');
    
    // Validate receipts
    const receiptsSelect = this.querySelector('[name="receipts"]');
    if (receiptsSelect.selectedOptions.length === 0) {
      alert('Por favor seleccione al menos un comprobante verificado');
      receiptsSelect.classList.add('border-warning-500');
      return;
    }
    
    receiptsSelect.classList.remove('border-warning-500');
    
    // Collect form data
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Get selected receipts details
    const selectedReceipts = Array.from(receiptsSelect.selectedOptions).map(option => {
      return {
        id: option.value,
        text: option.text
      };
    });
    data.receiptsDetails = selectedReceipts;
  
    
    // Show success message and redirect
    alert('Solicitud de reembolso enviada correctamente');
    window.location.reload();
  });
</script>
