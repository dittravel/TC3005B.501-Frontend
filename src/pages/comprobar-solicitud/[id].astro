---
/**
 * Shows the receipts uploaded to a specific request.
 */

export const prerender = false;

import MainLayout from "@layouts/MainLayout.astro";
import TextHeader from "@components/TextHeader.astro";
import Button from "@components/Button";
import { getCookie } from "@data/cookies";
import ValidateReceiptStatus from "@components/ValidateReceiptStatus.tsx";

import type { UserRole } from "@type/roles";

const userName = getCookie("username", Astro.cookies) || "";
const role = getCookie("role", Astro.cookies) as UserRole;
const buttonLabel = role;


import { apiRequest } from "@/utils/apiClient";

const { id } = Astro.params;
let request = null;
try {
  request = await apiRequest(`/accounts-payable/get-expense-validations/${id}`, { cookies: Astro.cookies });
} catch (error) {
  request = null;
  throw new Error(`No request found with ID ${id}`);
}

const StateColors = {
  'Aprobado': ' text-success-500',
  'Rechazado': ' text-warning-500',
  'Pendiente': ' text-alert-400'
};

---

<MainLayout title={`Comprobantes de la solicitud #${id}`} data={{userName, role, buttonLabel}}>
  <main>
    <TextHeader
      title={`Lista de comprobantes de la solicitud #${id}`}
      subtitle="Aquí puedes ver o subir tus comprobantes de gasto"
    />
    <div class="flex justify-end mb-6">
      <a href={`/subir-comprobante/${id}`} class="w-auto">
        <Button color="secondary" variant="filled" size="medium">
          Agregar Comprobante
        </Button>
      </a>
    </div>
    <section>
      {request.Expenses.length > 0 ? (
        <div class="grid gap-4">
          {request.Expenses.map((expense: any, index: number) => (
            <div class="content-wrapper">
              <div class="flex flex-col md:flex-row justify-between gap-4 mb-4">
                <div class="space-y-1">
                  <p class="font-bold text-lg text-text-primary">Comprobante #{index + 1}</p>
                  <p class="text-sm text-text-primary"><span class="font-semibold">Id:</span> {expense.receipt_id}</p>
                  <p class="text-sm text-text-primary"><span class="font-semibold">Tipo de gasto:</span> {expense.receipt_type_name}</p>
                  <p class="text-sm text-text-primary"><span class="font-semibold">Monto:</span> ${expense.amount}</p>
                </div>
                <div class="text-right">
                  <p class={`text-lg font-semibold ${StateColors[expense.validation as keyof typeof StateColors]}`}>
                    {expense.validation}
                  </p>
                </div>
              </div>
              {expense.validation === 'Rechazado' && (
                <a href={`/resubir-comprobante/${id}?replace=${expense.receipt_id}`} class="w-full">
                  <Button color="warning" variant="border" size="medium" customSizeClass="w-full">
                    Volver a subir
                  </Button>
                </a>
              )}
            </div>
          ))}
        </div>
      ) : (
        <div class="content-wrapper">
          <p class="text-center text-text-secondary font-semibold">
            Aún no has subido comprobantes para esta solicitud.
          </p>
        </div>
      )}
    </section>
    <div class="fixed bottom-6 right-6 z-50">
      <ValidateReceiptStatus
        client:only="react"
        request_id={Number(id)}
        title="Confirmar envío"
        message="¿Está seguro de que desea mandar estos comprobantes?"
        redirection="/dashboard"
        modal_type="success"
        variant="primary"
        token={getCookie("token", Astro.cookies) || ""}
      >
        <Button color="success" variant="filled" size="medium">
          Mandar a validar
        </Button>
      </ValidateReceiptStatus>
    </div>
  </main>
</MainLayout>
