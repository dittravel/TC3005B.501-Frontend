---
/**
 * Page for checking the status of expense verification for applicants
 */

import MainLayout from "@layouts/MainLayout.astro";
import TextHeader from "@components/TextHeader.astro";
import Button from "@components/Button";
import type { UserRole } from "@type/roles";

import { getCookie } from "@data/cookies";
import { roleLabels } from "@config/role-labels";
import { apiRequest } from '@utils/apiClient';

const role: UserRole = getCookie("role", Astro.cookies) as UserRole;
const userName = getCookie("username", Astro.cookies) || "";
const buttonLabel = roleLabels[role];
const user_id = getCookie("id", Astro.cookies);

function getVerificationStats(request: any) {
  const verifications = Array.isArray(request.verifications) ? request.verifications : [];
  const total = verifications.length;
  const accepted = verifications.filter((v: any) => v.validation === 'Aprobado').length;
  const rejected = verifications.filter((v: any) => v.validation === 'Rechazado').length;
  const pending = verifications.filter((v: any) => v.validation === 'Pendiente').length;
  return { total, accepted, rejected, pending };
}

// Obtener solicitudes
const requestsRaw = await (async () => {
  try {
    const requests = await apiRequest(`/applicant/get-user-requests/${user_id}`, { cookies: Astro.cookies });
    return Array.isArray(requests)
      ? requests.filter((request: any) => request.status === 'Comprobación gastos del viaje')
      : [];
  } catch (error) {
    return [];
  }
})();

// Agregar verificaciones a cada solicitud
const requests = await Promise.all(
  requestsRaw.map(async (request: any) => {
    try {
      const { Expenses } = await apiRequest(`/accounts-payable/get-expense-validations/${request.request_id}`, { cookies: Astro.cookies });
      return { ...request, verifications: Expenses ?? [] };
    } catch (e) {
      console.error(`Error al cargar verificaciones de ${request.request_id}`, e);
      return { ...request, verifications: [] };
    }
  })
);
---

<MainLayout title="Dashboard" data={{userName, buttonLabel, role}}>
  <div>
    <main>
      <TextHeader
        title={`Comprobaciones pendientes de ${userName}`}
        subtitle="Aquí puedes conocer el estado de solicitudes en proceso de comprobación"
      />
      <section>
        {requests.length > 0 ? (
          <div class="grid gap-4">
            {requests.map((request: any) => {
              const { total, accepted, rejected, pending } = getVerificationStats(request);
              const percent = (count: number) => total ? (count / total) * 100 : 0;
              return (
                <div class="content-wrapper">
                <div class="grid grid-cols-[1fr] md:grid-cols-[2fr_1fr] gap-8 md:gap-8">
                  <a href={`/comprobar-solicitud/${request.request_id}`} class="block">
                    <div class="space-y-2">
                      <p class="font-bold text-lg text-text-primary">#{request.request_id}</p>
                      { total === 0 ? (
                        <p class="text-sm text-text-secondary">
                          No se han enviado comprobantes
                        </p>
                      ) : (
                        <div class="flex items-center justify-between">
                          <p class="text-sm text-text-secondary">{accepted}/{total} Aceptadas</p>
                        </div>
                      )}
                      { total != 0 && (
                        <div class="w-full h-2 bg-card rounded overflow-hidden flex">
                          <div class="bg-success-500 h-full" style={`width: ${percent(accepted)}%`} />
                          <div class="bg-warning-500 h-full" style={`width: ${percent(rejected)}%`} />
                          <div class="bg-alert-400 h-full" style={`width: ${percent(pending)}%`} />
                        </div>
                      )}

                      <div class="text-sm text-text-primary grid grid-cols-[1fr_2fr] gap-y-1">
                        <p><span class="font-semibold">Lugar:</span> {request.destination_country}</p>
                        <p><span class="font-semibold">Fechas:</span> {request.beginning_date} - {request.ending_date}</p>
                        <p>
                          <span class="font-semibold">Estado:</span> 
                          <span
                            class={`ml-1 font-semibold ${
                              pending > 0
                                ? 'text-alert-400'
                                : accepted === total
                                  ? 'text-success-500'
                                  : rejected === total
                                    ? 'text-warning-500'
                                    : 'text-primary-500'
                            }`}
                          >
                            {pending > 0 || total === 0
                              ? 'PENDIENTE'
                              : accepted === total
                                ? 'ACEPTADA'
                                : rejected === total
                                  ? 'RECHAZADA'
                                  : 'MIXTA'}
                          </span>
                        </p>
                        <p><span class="font-semibold">Responsable:</span> Eduardo Porto Morales</p>
                      </div>
                    </div>
                  </a>
                  <div class="flex flex-col gap-2 justify-center items-center">
                    <a href={`/comprobar-solicitud/${request.request_id}`} class="w-full">
                      <Button color="secondary" variant="filled" size="medium" customSizeClass="w-full">
                        Ver Comprobantes
                      </Button>
                    </a>
                  </div>
                </div>
                </div>
              );
            })}
          </div>
        ) : (
          <div class="content-wrapper">
            <div class="text-center text-text-secondary font-semibold">
              No tienes comprobantes pendientes
            </div>
          </div>
        )}
      </section>
    </main>
  </div>
</MainLayout>
