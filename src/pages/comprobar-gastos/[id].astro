---
/**
 * This is the page where we separate the content that is stablished for a certain user of Account Payable team.
 */

export const prerender = false;
import MainLayout from "@layouts/MainLayout.astro";
import TextHeader from "@components/TextHeader.astro";
import ReceiptActions from "@components/ReceiptActions";
import Button from "@components/Button";
import type { UserRole } from "@type/roles";
import FinishRequestButton from "@components/FinisCheck.tsx";

import { getCookie } from "@data/cookies";
import { roleLabels } from "@config/role-labels";

const role: UserRole = getCookie("role", Astro.cookies) as UserRole;
const userName = getCookie("username", Astro.cookies) || "";
const buttonLabel = roleLabels[role];

const validationColors = {
  "Aprobado": "bg-success/20 text-success-500",
  "Rechazado": "bg-warning/20 text-warning-500",
  "Pendiente": "bg-alert/20 text-alert-400",
};

import { apiRequest } from "@/utils/apiClient";

const { id } = Astro.params;
let request = null;
try {
  request = await apiRequest(`/accounts-payable/get-expense-validations/${id}`, { cookies: Astro.cookies });
  console.log(request);
} catch (error) {
  request = null;
  throw new Error(`No request found with ID ${id}`);
}

const numericId = Number(id);
if (isNaN(numericId)) {
  throw new Error(`El ID debe ser numÃ©rico. Recibido: ${id}`);
}

const enrichedExpenses = await Promise.all(
  request.Expenses.map(async (receipt: any) => {
    const fileMap = await apiRequest(`/files/receipt-files/${receipt.receipt_id}`, { cookies: Astro.cookies });
    return { ...receipt, fileMap };
  })
);
const allReviewed = enrichedExpenses.every((receipt: any) => receipt.validation !== "Pendiente");
---

<MainLayout title={`Solicitud #${request.request_id}`} data={{userName, buttonLabel, role}} >
  <main class="flex flex-col items-center w-full">
    <TextHeader
      title={`Solicitud #${request.request_id}`}
      subtitle="Comprobantes de Gastos"
    />

    <section class="w-full">
      <div class="flex flex-row items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-text-primary">Comprobantes ({enrichedExpenses.length})</h2>
        {allReviewed && (
          <FinishRequestButton
            client:only="react"
            requestId={request.request_id}
            token={getCookie("token", Astro.cookies) || ""}
          />
        )}
      </div>

      {enrichedExpenses.length === 0 ? (
        <div class="bg-card p-6 rounded-lg border border-border w-full text-center text-text-secondary font-semibold">
          No hay comprobantes de gastos para revisar
        </div>
      ) : (
        <div class="space-y-4">
          {enrichedExpenses.map((receipt: any) => {
            const pdf = receipt.fileMap?.pdf;
            const xml = receipt.fileMap?.xml;

            return (
              <div class="content-wrapper">
                <div class="grid grid-cols-[1fr] md:grid-cols-[2fr_1fr] gap-6">
                  <div class="space-y-3">
                    <p class="font-bold text-lg text-text-primary">#{receipt.receipt_id}</p>
                    <div class="text-sm text-text-primary space-y-1">
                      <p><span class="font-semibold">Monto:</span> ${receipt.amount} MXN</p>
                      <p><span class="font-semibold">Rubro:</span> {receipt.receipt_type_name}</p>
                    </div>
                  </div>

                  <div class="flex flex-col gap-2 justify-start">
                    <span class={`inline-block px-3 py-1 text-xs font-semibold rounded-full self-end ${validationColors[receipt.validation as keyof typeof validationColors] || "bg-primary/20 text-text-secondary"}`}>
                      {receipt.validation}
                    </span>

                    {pdf && (
                      <Button
                        href={`${import.meta.env.PUBLIC_API_BASE_URL}/files/receipt-file/${pdf.fileId}`}
                        color="secondary"
                        variant="border"
                        size="small"
                        customSizeClass="w-full flex flex-col items-center justify-center gap-y-1 py-3"
                        title={`Descargar: ${pdf.fileName}`}
                      >
                        <span class="text-xs font-semibold truncate">{pdf.fileName}</span>
                        <span class="text-sm">Descargar PDF</span>
                      </Button>
                    )}

                    {xml && (
                      <Button
                        href={`${import.meta.env.PUBLIC_API_BASE_URL}/files/receipt-file/${xml.fileId}`}
                        color="secondary"
                        variant="border"
                        size="small"
                        customSizeClass="w-full flex flex-col items-center justify-center gap-y-1 py-3"
                        title={`Descargar: ${xml.fileName}`}
                      >
                        <span class="text-sm">Descargar XML</span>
                        <span class="text-xs font-semibold truncate">{xml.fileName}</span>
                      </Button>
                    )}

                    {receipt.validation === "Pendiente" && (
                      <ReceiptActions
                        client:only="react"
                        receipt_id={receipt.receipt_id}
                        expense_status={receipt.expense_status}
                        disabled={false}
                        token={getCookie("token", Astro.cookies) || ""}
                      />
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </section>
  </main>
</MainLayout>
